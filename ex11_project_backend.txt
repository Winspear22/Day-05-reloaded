================================================================================
PROJECT STRUCTURE OVERVIEW - ex11
================================================================================

Root Directory: ./ex11/

./ex11
â”œâ”€â”€ bin
â”‚Â Â  â””â”€â”€ console
â”œâ”€â”€ composer.json
â”œâ”€â”€ composer.lock
â”œâ”€â”€ config
â”‚Â Â  â”œâ”€â”€ bundles.php
â”‚Â Â  â”œâ”€â”€ packages
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ cache.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ doctrine_migrations.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ doctrine.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ framework.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ routing.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ twig.yaml
â”‚Â Â  â”‚Â Â  â””â”€â”€ validator.yaml
â”‚Â Â  â”œâ”€â”€ preload.php
â”‚Â Â  â”œâ”€â”€ routes
â”‚Â Â  â”‚Â Â  â””â”€â”€ framework.yaml
â”‚Â Â  â”œâ”€â”€ routes.yaml
â”‚Â Â  â””â”€â”€ services.yaml
â”œâ”€â”€ migrations
â”œâ”€â”€ public
â”‚Â Â  â”œâ”€â”€ index.php
â”‚Â Â  â””â”€â”€ style.css
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ Controller
â”‚Â Â  â”‚Â Â  â””â”€â”€ Ex11Controller.php
â”‚Â Â  â”œâ”€â”€ DataFixtures
â”‚Â Â  â”‚Â Â  â””â”€â”€ AppFixtures.php
â”‚Â Â  â”œâ”€â”€ Entity
â”‚Â Â  â”œâ”€â”€ Kernel.php
â”‚Â Â  â”œâ”€â”€ Repository
â”‚Â Â  â””â”€â”€ Service
â”‚Â Â      â”œâ”€â”€ CreateAddressesTableService.php
â”‚Â Â      â”œâ”€â”€ CreateBankAccountsTableService.php
â”‚Â Â      â”œâ”€â”€ CreatePersonsTableService.php
â”‚Â Â      â”œâ”€â”€ DeleteAllTablesService.php
â”‚Â Â      â”œâ”€â”€ LoadDemoDataService.php
â”‚Â Â      â””â”€â”€ UtilsTableService.php
â”œâ”€â”€ symfony.lock
â”œâ”€â”€ templates
â”‚Â Â  â”œâ”€â”€ base.html.twig
â”‚Â Â  â”œâ”€â”€ bundles
â”‚Â Â  â”‚Â Â  â””â”€â”€ TwigBundle
â”‚Â Â  â””â”€â”€ ex11
â”‚Â Â      â””â”€â”€ index.html.twig
â”œâ”€â”€ var
â”‚Â Â  â”œâ”€â”€ cache
â”‚Â Â  â”‚Â Â  â””â”€â”€ dev
â”‚Â Â  â””â”€â”€ log
â””â”€â”€ vendor
    â”œâ”€â”€ autoload.php
    â”œâ”€â”€ autoload_runtime.php
    â”œâ”€â”€ bin
    â”‚Â Â  â”œâ”€â”€ doctrine-migrations
    â”‚Â Â  â”œâ”€â”€ patch-type-declarations
    â”‚Â Â  â”œâ”€â”€ php-parse
    â”‚Â Â  â”œâ”€â”€ sql-formatter
    â”‚Â Â  â”œâ”€â”€ var-dump-server
    â”‚Â Â  â””â”€â”€ yaml-lint
    â”œâ”€â”€ composer
    â”‚Â Â  â”œâ”€â”€ autoload_classmap.php
    â”‚Â Â  â”œâ”€â”€ autoload_files.php
    â”‚Â Â  â”œâ”€â”€ autoload_namespaces.php
    â”‚Â Â  â”œâ”€â”€ autoload_psr4.php
    â”‚Â Â  â”œâ”€â”€ autoload_real.php
    â”‚Â Â  â”œâ”€â”€ autoload_static.php
    â”‚Â Â  â”œâ”€â”€ ClassLoader.php
    â”‚Â Â  â”œâ”€â”€ installed.json
    â”‚Â Â  â”œâ”€â”€ installed.php
    â”‚Â Â  â”œâ”€â”€ InstalledVersions.php
    â”‚Â Â  â”œâ”€â”€ LICENSE
    â”‚Â Â  â””â”€â”€ platform_check.php
    â”œâ”€â”€ doctrine
    â”‚Â Â  â”œâ”€â”€ annotations
    â”‚Â Â  â”œâ”€â”€ collections
    â”‚Â Â  â”œâ”€â”€ data-fixtures
    â”‚Â Â  â”œâ”€â”€ dbal
    â”‚Â Â  â”œâ”€â”€ deprecations
    â”‚Â Â  â”œâ”€â”€ doctrine-bundle
    â”‚Â Â  â”œâ”€â”€ doctrine-fixtures-bundle
    â”‚Â Â  â”œâ”€â”€ doctrine-migrations-bundle
    â”‚Â Â  â”œâ”€â”€ event-manager
    â”‚Â Â  â”œâ”€â”€ inflector
    â”‚Â Â  â”œâ”€â”€ instantiator
    â”‚Â Â  â”œâ”€â”€ lexer
    â”‚Â Â  â”œâ”€â”€ migrations
    â”‚Â Â  â”œâ”€â”€ orm
    â”‚Â Â  â”œâ”€â”€ persistence
    â”‚Â Â  â””â”€â”€ sql-formatter
    â”œâ”€â”€ fakerphp
    â”‚Â Â  â””â”€â”€ faker
    â”œâ”€â”€ nikic
    â”‚Â Â  â””â”€â”€ php-parser
    â”œâ”€â”€ psr
    â”‚Â Â  â”œâ”€â”€ cache
    â”‚Â Â  â”œâ”€â”€ container
    â”‚Â Â  â”œâ”€â”€ event-dispatcher
    â”‚Â Â  â””â”€â”€ log
    â”œâ”€â”€ symfony
    â”‚Â Â  â”œâ”€â”€ asset
    â”‚Â Â  â”œâ”€â”€ cache
    â”‚Â Â  â”œâ”€â”€ cache-contracts
    â”‚Â Â  â”œâ”€â”€ config
    â”‚Â Â  â”œâ”€â”€ console
    â”‚Â Â  â”œâ”€â”€ dependency-injection
    â”‚Â Â  â”œâ”€â”€ deprecation-contracts
    â”‚Â Â  â”œâ”€â”€ doctrine-bridge
    â”‚Â Â  â”œâ”€â”€ dotenv
    â”‚Â Â  â”œâ”€â”€ error-handler
    â”‚Â Â  â”œâ”€â”€ event-dispatcher
    â”‚Â Â  â”œâ”€â”€ event-dispatcher-contracts
    â”‚Â Â  â”œâ”€â”€ filesystem
    â”‚Â Â  â”œâ”€â”€ finder
    â”‚Â Â  â”œâ”€â”€ flex
    â”‚Â Â  â”œâ”€â”€ form
    â”‚Â Â  â”œâ”€â”€ framework-bundle
    â”‚Â Â  â”œâ”€â”€ http-foundation
    â”‚Â Â  â”œâ”€â”€ http-kernel
    â”‚Â Â  â”œâ”€â”€ maker-bundle
    â”‚Â Â  â”œâ”€â”€ options-resolver
    â”‚Â Â  â”œâ”€â”€ polyfill-intl-grapheme
    â”‚Â Â  â”œâ”€â”€ polyfill-intl-icu
    â”‚Â Â  â”œâ”€â”€ polyfill-intl-normalizer
    â”‚Â Â  â”œâ”€â”€ polyfill-mbstring
    â”‚Â Â  â”œâ”€â”€ polyfill-php83
    â”‚Â Â  â”œâ”€â”€ polyfill-php84
    â”‚Â Â  â”œâ”€â”€ process
    â”‚Â Â  â”œâ”€â”€ property-access
    â”‚Â Â  â”œâ”€â”€ property-info
    â”‚Â Â  â”œâ”€â”€ routing
    â”‚Â Â  â”œâ”€â”€ runtime
    â”‚Â Â  â”œâ”€â”€ service-contracts
    â”‚Â Â  â”œâ”€â”€ stopwatch
    â”‚Â Â  â”œâ”€â”€ string
    â”‚Â Â  â”œâ”€â”€ translation-contracts
    â”‚Â Â  â”œâ”€â”€ twig-bridge
    â”‚Â Â  â”œâ”€â”€ twig-bundle
    â”‚Â Â  â”œâ”€â”€ validator
    â”‚Â Â  â”œâ”€â”€ var-dumper
    â”‚Â Â  â”œâ”€â”€ var-exporter
    â”‚Â Â  â””â”€â”€ yaml
    â””â”€â”€ twig
        â”œâ”€â”€ extra-bundle
        â””â”€â”€ twig

95 directories, 49 files

================================================================================

ðŸ“‚ SOURCE CODE (src/) - Location: ex11/src/
================================================================================


---
File: src/Controller/Ex11Controller.php
---

<?php

namespace App\Controller;

use Exception;
use Doctrine\DBAL\Connection;
use App\Service\LoadDemoDataService;
use App\Service\DeleteAllTablesService;
use App\Service\CreatePersonsTableService;
use App\Service\CreateAddressesTableService;
use Symfony\Component\HttpFoundation\Response;
use App\Service\CreateBankAccountsTableService;
use Symfony\Component\Routing\Annotation\Route;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;

final class Ex11Controller extends AbstractController
{

    public function __construct(
        private readonly Connection $sql_connection,
        private readonly CreatePersonsTableService $createPersonsTable,
        private readonly CreateBankAccountsTableService $createBankAccountsTable,
        private readonly CreateAddressesTableService $createAddressesTable,
        private readonly DeleteAllTablesService $deleteTable,
        private readonly LoadDemoDataService $loadDemoData
    ) {}

    /**
     * @Route("/ex11", name="ex11_index")
     */
    public function index(): Response
    {  
        return $this->render('ex10/index.html.twig');
    }

    /**
     * @Route("/ex11/create_all_tables", name="ex11_create_all_tables", methods={"POST"})
     */
    public function createAllTables(): Response
    {
        try
        {
            $result = $this->createPersonsTable->createPersonsTable('ex11_persons');
            [$type, $msg] = explode(':', $result, 2);
            $this->addFlash($type, $msg);
            $result = $this->createBankAccountsTable->createBankAccountsTable('ex11_bank_accounts');
            [$type, $msg] = explode(':', $result, 2);
            $this->addFlash($type, $msg);
            $result = $this->createAddressesTable->createAddressesTable('ex11_addresses');
            [$type, $msg] = explode(':', $result, 2);
            $this->addFlash($type, $msg);
        }
        catch (Exception $e)
        {
            $this->addFlash('danger', 'Error: ' . $e->getMessage());
        }
        return $this->redirectToRoute('ex11_index');
    }

    /**
     * @Route("/ex11/delete_all_tables", name="ex11_delete_all_tables", methods={"POST"})
     */
    public function deleteAllTables(): Response
    {
        try
        {
            $result = $this->deleteTable->deleteTable("ex11_bank_accounts");
            [$type, $msg] = explode(':', $result, 2);
            $this->addFlash($type, $msg);
            $result = $this->deleteTable->deleteTable("ex11_addresses");
            [$type, $msg] = explode(':', $result, 2);
            $this->addFlash($type, $msg);
            $result = $this->deleteTable->deleteTable("ex11_persons");
            [$type, $msg] = explode(':', $result, 2);
            $this->addFlash($type, $msg);
        }
        catch (Exception $e)
        {
            $this->addFlash('danger', 'Error: ' . $e->getMessage());
        }
        return $this->redirectToRoute('ex11_index');
    }

    /**
     * @Route("/ex11/load_demo_data", name="ex11_load_demo_data", methods={"POST"})
     */
    public function loadDemoData(): Response
    {
        try
        {
            $result = $this->loadDemoData->loadData();
            [$type, $msg] = explode(':', $result, 2);
            $this->addFlash($type, $msg);
            return $this->redirectToRoute('ex11_index');
        }
        catch (Exception $e)
        {
            $this->addFlash('danger', 'Error: ' . $e->getMessage());
        }
        return $this->redirectToRoute('ex11_index');

    }   
}


---
File: src/DataFixtures/AppFixtures.php
---

<?php

namespace App\DataFixtures;

use Faker\Factory;
use Doctrine\DBAL\Connection;
use Doctrine\Persistence\ObjectManager;
use Doctrine\Bundle\FixturesBundle\Fixture;

class AppFixtures extends Fixture
{
    public function __construct(
        private readonly Connection $connection) {}
    public function load(ObjectManager $manager): void
    {
        $faker = Factory::create('fr_FR');

        // InsÃ©rer 20 personnes
        for ($i = 1; $i <= 20; $i++)
        {
            $sql = "INSERT INTO ex11_persons (username, name, email, enable, birthdate) 
                    VALUES (?, ?, ?, ?, ?)";
            $this->connection->executeStatement($sql, [
                $faker->unique()->userName(),
                $faker->name(),
                $faker->unique()->email(),
                $faker->boolean(),
                $faker->dateTime()->format('Y-m-d H:i:s')
            ]);
        }

        // InsÃ©rer 20 adresses
        for ($i = 1; $i <= 20; $i++)
        {
            $sql = "INSERT INTO ex11_addresses (person_id, address) 
                    VALUES (?, ?)";
            $this->connection->executeStatement($sql, [
                $i,
                $faker->address()
            ]);
        }

        // InsÃ©rer 20 comptes bancaires
        for ($i = 1; $i <= 20; $i++)
        {
            $sql = "INSERT INTO ex11_bank_accounts (person_id, iban, bank_name) 
                    VALUES (?, ?)";
            $this->connection->executeStatement($sql, [
                $i,
                $faker->iban('FR'),
                $faker->company()
            ]);
        }
    }
}


---
File: src/Kernel.php
---

<?php

namespace App;

use Symfony\Bundle\FrameworkBundle\Kernel\MicroKernelTrait;
use Symfony\Component\HttpKernel\Kernel as BaseKernel;

class Kernel extends BaseKernel
{
    use MicroKernelTrait;
}


---
File: src/Service/CreateAddressesTableService.php
---

<?php

namespace App\Service;

use Exception;
use Doctrine\DBAL\Connection;
use App\Service\UtilsTableService;

class CreateAddressesTableService
{
	public function __construct(
		private readonly Connection $sql_connection,
		private readonly UtilsTableService $utilsTableService) {}

	public function createAddressesTable(string $tableName): string
    {
		$sql_command = "CREATE TABLE IF NOT EXISTS $tableName (
			id INT AUTO_INCREMENT PRIMARY KEY,
			person_id INT NOT NULL,
			address LONGTEXT NOT NULL,
			FOREIGN KEY (person_id) REFERENCES ex11_persons(id) ON DELETE CASCADE
		)";	
		try
		{
			if ($this->utilsTableService->checkTableExistence($tableName))
				return "info:The table $tableName already exists and cannot be created again.";
			$this->sql_connection->executeStatement($sql_command);
            return "success:Success! The table $tableName was created!";
		}
		catch (Exception $e)
		{
			return "danger:Error, there was a problem in the table $tableName creation : " . $e->getMessage();
		}
    }
}

?>

---
File: src/Service/CreateBankAccountsTableService.php
---

<?php

namespace App\Service;

use Exception;
use Doctrine\DBAL\Connection;
use App\Service\UtilsTableService;

class CreateBankAccountsTableService
{
	public function __construct(
		private readonly Connection $sql_connection,
		private readonly UtilsTableService $utilsTableService) {}

	public function createBankAccountsTable(string $tableName): string
    {
		$sql_command = "CREATE TABLE IF NOT EXISTS $tableName (
			id INT AUTO_INCREMENT PRIMARY KEY,
			person_id INT NOT NULL,
			iban VARCHAR(34) NOT NULL,
			bank_name VARCHAR(50) NOT NULL,
			FOREIGN KEY (person_id) REFERENCES ex11_persons(id) ON DELETE CASCADE
		)";
		try
		{
			if ($this->utilsTableService->checkTableExistence($tableName))
				return "info:The table $tableName already exists and cannot be created again.";
			$this->sql_connection->executeStatement($sql_command);
            return "success:Success! The table $tableName was created!";
		}
		catch (Exception $e)
		{
			return "danger:Error, there was a problem in the table $tableName creation : " . $e->getMessage();
		}
    }
}

?>

---
File: src/Service/CreatePersonsTableService.php
---

<?php

namespace App\Service;

use Exception;
use Doctrine\DBAL\Connection;
use App\Service\UtilsTableService;

class CreatePersonsTableService
{
	public function __construct(
		private readonly Connection $sql_connection,
		private readonly UtilsTableService $utilsTableService) {}

	public function createPersonsTable(string $tableName): string
	{
		$sql_command = "CREATE TABLE IF NOT EXISTS $tableName (
			id INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
			username VARCHAR(64) NOT NULL UNIQUE,
			name VARCHAR(64) NOT NULL,
			email VARCHAR(128) NOT NULL UNIQUE,
			enable BOOL DEFAULT FALSE NOT NULL,
			birthdate DATETIME NOT NULL)";
		try
		{
			if ($this->utilsTableService->checkTableExistence($tableName))
				return "info:The table $tableName already exists and cannot be created again.";
			$this->sql_connection->executeStatement($sql_command);
            return "success:Success! The table $tableName was created!";
		}
		catch (Exception $e)
		{
			return "danger:Error, there was a problem in the table $tableName creation : " . $e->getMessage();
		}
	}
}

?>

---
File: src/Service/DeleteAllTablesService.php
---

<?php

namespace App\Service;

use Exception;
use App\Service\UtilsService;
use Doctrine\DBAL\Connection;

class DeleteAllTablesService
{
	public function __construct(
		private readonly Connection $sql_connection,
		private readonly UtilsService $utils_service,
	) {}

	public function deleteTable(string $tableName): string
	{
		$sql_command = "DELETE FROM $tableName";
		try
		{
			if (!$this->utils_service->checkTableExistenceSQL($tableName))
				return "danger:The table $tableName does not exist (SQL).";
			$this->sql_connection->executeStatement($sql_command);
			return "success:Success! All data deleted from $tableName.";
		}
		catch (Exception $e)
		{
			return "danger:Error while deleting all data: " . $e->getMessage();
		}
	}
}
?>

---
File: src/Service/LoadDemoDataService.php
---

<?php

namespace App\Service;

use Faker\Factory;
use Doctrine\DBAL\Connection;
use Exception;

class LoadDemoDataService
{
    public function __construct(private readonly Connection $connection) {}

    public function loadData(): string
    {
        try
        {
            $faker = Factory::create('fr_FR');

            // Vider les tables (respecter les FK)
            $this->connection->executeStatement("DELETE FROM ex11_bank_accounts");
            $this->connection->executeStatement("DELETE FROM ex11_addresses");
            $this->connection->executeStatement("DELETE FROM ex11_persons");

            // InsÃ©rer 20 personnes
            for ($i = 1; $i <= 20; $i++)
            {
                $sql = "INSERT INTO ex11_persons (username, name, email, enable, birthdate) 
                        VALUES (?, ?, ?, ?, ?)";
                $this->connection->executeStatement($sql, [
                    $faker->unique()->userName(),
                    $faker->name(),
                    $faker->unique()->email(),
                    $faker->boolean(),
                    $faker->dateTime()->format('Y-m-d H:i:s')
                ]);
            }

            // InsÃ©rer 20 adresses
            for ($i = 1; $i <= 20; $i++)
            {
                $sql = "INSERT INTO ex11_addresses (person_id, address) 
                        VALUES (?, ?)";
                $this->connection->executeStatement($sql, [
                    $i,
                    $faker->address()
                ]);
            }

            // InsÃ©rer 20 comptes bancaires
            for ($i = 1; $i <= 20; $i++)
            {
                $sql = "INSERT INTO ex11_bank_accounts (person_id, iban, bank_name) 
                        VALUES (?, ?)";
                $this->connection->executeStatement($sql, [
                    $i,
                    $faker->iban('FR'),
                    $faker->company()
                ]);
            }

            return "success:20 personnes, adresses et comptes bancaires chargÃ©s !";
        }
        catch (Exception $e)
        {
            return "danger:Erreur lors du chargement des donnÃ©es : " . $e->getMessage();
        }
    }
}


---
File: src/Service/UtilsTableService.php
---

<?php

namespace App\Service;

use Exception;
use Doctrine\DBAL\Connection;

class UtilsTableService
{

	public function __construct(
		private readonly Connection $sql_connection) {}
	public function checkTableExistence(string $tableName): bool 
	{
		try
		{
			$result = $this->sql_connection->fetchOne("SHOW TABLES LIKE ?", [$tableName]);
			if ($result === false)
				return false;
		}
		catch (Exception $e)
		{
			return false;
		}
		return true;
	}

	public function doesColumnExist(string $tableName, string $columnName): bool
	{
		try
		{
			$columns = $this->sql_connection->fetchAllAssociative("SHOW COLUMNS FROM $tableName LIKE :column", ['column' => $columnName]);
			return count($columns) > 0;
		}
		catch (Exception $e)
		{
			return false;
		}
	}

	public function checkIfRelationBetweenTablesIsPossible(string $motherTableName, string $daughterTableName): bool
	{
		if (!$this->checkTableExistence($daughterTableName))
            return false;
        if (!$this->checkTableExistence($motherTableName))
            return false;
		if ($this->doesColumnExist($daughterTableName, 'person_id'))
			return false;
		return true;
	}
	
	public function getRelationErrorMessage(string $motherTableName, string $daughterTableName): string
    {
        if (!$this->checkTableExistence($daughterTableName))
            return "danger:Error, the table $daughterTableName does not exist.";
        if (!$this->checkTableExistence($motherTableName))
            return "danger:Error, the table $motherTableName does not exist.";
        if ($this->doesColumnExist($daughterTableName, 'person_id'))
            return "danger:Error! Relation between $daughterTableName and $motherTableName already exists.";
        return "";
    }
}
?>

================================================================================

ðŸ“‚ PUBLIC FILES (public/) - Location: ex11/public/
================================================================================


---
File: public/index.php
---

<?php

use App\Kernel;

require_once dirname(__DIR__).'/vendor/autoload_runtime.php';

return function (array $context) {
    return new Kernel($context['APP_ENV'], (bool) $context['APP_DEBUG']);
};


---
File: public/style.css
---

.alert
{
    padding: 1em 1.5em;
    margin: 1em 0;
    border-radius: 5px;
    font-weight: bold;
    box-shadow: 0 1px 7px #aaa1;
    font-size: 1em;
}

.alert-success
{
    background: #d4edda;
    color: #155724;
    border-left: 7px solid #38a169;
}

.alert-danger
{
    background: #f8d7da;
    color: #721c24;
    border-left: 7px solid #e53e3e;
}

.alert-info
{
    background: #ffee00;
    color: #000000;
    border-left: 7px solid #d8db38;
}
