================================================================================
PROJECT STRUCTURE OVERVIEW - ex09
================================================================================

Root Directory: ./ex09/

./ex09
â”œâ”€â”€ bin
â”‚Â Â  â””â”€â”€ console
â”œâ”€â”€ composer.json
â”œâ”€â”€ composer.lock
â”œâ”€â”€ config
â”‚Â Â  â”œâ”€â”€ bundles.php
â”‚Â Â  â”œâ”€â”€ packages
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ cache.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ doctrine_migrations.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ doctrine.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ framework.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ routing.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ twig.yaml
â”‚Â Â  â”‚Â Â  â””â”€â”€ validator.yaml
â”‚Â Â  â”œâ”€â”€ preload.php
â”‚Â Â  â”œâ”€â”€ routes
â”‚Â Â  â”‚Â Â  â””â”€â”€ framework.yaml
â”‚Â Â  â”œâ”€â”€ routes.yaml
â”‚Â Â  â””â”€â”€ services.yaml
â”œâ”€â”€ migrations
â”‚Â Â  â”œâ”€â”€ Version20251109120844.php
â”‚Â Â  â””â”€â”€ Version20251109121119.php
â”œâ”€â”€ public
â”‚Â Â  â”œâ”€â”€ index.php
â”‚Â Â  â””â”€â”€ style.css
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ Controller
â”‚Â Â  â”‚Â Â  â””â”€â”€ Ex09Controller.php
â”‚Â Â  â”œâ”€â”€ Entity
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Address.php
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BankAccount.php
â”‚Â Â  â”‚Â Â  â””â”€â”€ Person.php
â”‚Â Â  â”œâ”€â”€ Kernel.php
â”‚Â Â  â”œâ”€â”€ Repository
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AddressRepository.php
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BankAccountRepository.php
â”‚Â Â  â”‚Â Â  â””â”€â”€ PersonRepository.php
â”‚Â Â  â””â”€â”€ Service
â”‚Â Â      â”œâ”€â”€ CreateTableService.php
â”‚Â Â      â”œâ”€â”€ DeleteTableService.php
â”‚Â Â      â””â”€â”€ UtilsTableService.php
â”œâ”€â”€ symfony.lock
â””â”€â”€ templates
    â”œâ”€â”€ base.html.twig
    â”œâ”€â”€ bundles
    â”‚Â Â  â””â”€â”€ TwigBundle
    â””â”€â”€ ex09
        â””â”€â”€ index.html.twig

15 directories, 33 files

================================================================================

ðŸ“‚ SOURCE CODE (src/) - Location: ex09/src/
================================================================================


---
File: src/Controller/Ex09Controller.php
---

<?php

namespace App\Controller;

use Exception;
use App\Service\CreateTableService;
use App\Service\DeleteTableService;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Attribute\Route;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;

final class Ex09Controller extends AbstractController
{
    public function __construct(
        private readonly CreateTableService $tableCreator,
        private readonly DeleteTableService $tableDeleter
    ) {}

    /**
     * @Route("/ex09", name="ex09_index", methods={"GET"})
     */
    public function index(): Response
    {  
        return $this->render('ex09/index.html.twig');
    }

    /**
     * @Route("/ex09/create_table_without_marital_status", name="ex09_create_table_without_marital_status", methods={"POST"})
     */
    public function createTableWithoutMaritalStatus(): Response
    {
        try
        {
            $result = $this->tableCreator->migrateToVersionWithoutMaritalStatus();
            [$type, $msg] = explode(':', $result, 2);
            $this->addFlash($type, $msg);
        }
        catch (Exception $e)
        {
            $this->addFlash('danger', "Error, unexpected error: " . $e->getMessage());
        }
        return $this->render('ex09/index.html.twig');
    }

    /**
     * @Route("/ex09/create_table_with_marital_status", name="ex09_create_table_with_marital_status", methods={"POST"})
     */
    public function createTableWithMaritalStatus(): Response
    {
        try
        {
            $result = $this->tableCreator->migrateToVersionWithMaritalStatus();
            [$type, $msg] = explode(':', $result, 2);
            $this->addFlash($type, $msg);
        }
        catch (Exception $e)
        {
            $this->addFlash('danger', 'Error: ' . $e->getMessage());
        }
        return $this->redirectToRoute('ex09_index');
    }

    /**
     * @Route("/ex09/drop_tables", name="ex09_drop_tables", methods={"POST"})
     */
    public function dropTables(): Response
    {
        try
        {
            $result = $this->tableDeleter->dropAllTables("ex09_persons");
            [$type, $msg] = explode(':', $result, 2);
            $this->addFlash($type, $msg);
        }
        catch (Exception $e)
        {
            $this->addFlash('danger', 'Error: ' . $e->getMessage());
        }
        return $this->redirectToRoute('ex09_index');
    }
}


---
File: src/Entity/Address.php
---

<?php

namespace App\Entity;

use App\Repository\AddressRepository;
use Doctrine\DBAL\Types\Types;
use Doctrine\ORM\Mapping as ORM;

#[ORM\Entity(repositoryClass: AddressRepository::class)]
#[ORM\Table(name: "ex09_addresses")]
class Address
{
    #[ORM\Id]
    #[ORM\GeneratedValue]
    #[ORM\Column]
    private ?int $id = null;

    #[ORM\Column(type: Types::TEXT)]
    private ?string $address = null;

    #[ORM\ManyToOne(inversedBy: 'addresses')]
    private ?Person $person = null;

    public function getId(): ?int
    {
        return $this->id;
    }

    public function getAddress(): ?string
    {
        return $this->address;
    }

    public function setAddress(string $address): static
    {
        $this->address = $address;

        return $this;
    }

    public function getPerson(): ?Person
    {
        return $this->person;
    }

    public function setPerson(?Person $person): static
    {
        $this->person = $person;

        return $this;
    }
}


---
File: src/Entity/BankAccount.php
---

<?php

namespace App\Entity;

use App\Repository\BankAccountRepository;
use Doctrine\ORM\Mapping as ORM;

#[ORM\Entity(repositoryClass: BankAccountRepository::class)]
#[ORM\Table(name: "ex09_bank_accounts")]
class BankAccount
{
    #[ORM\Id]
    #[ORM\GeneratedValue]
    #[ORM\Column]
    private ?int $id = null;

    #[ORM\Column(length: 34)]
    private ?string $iban = null;

    #[ORM\Column(length: 50)]
    private ?string $bank_name = null;

    #[ORM\OneToOne(inversedBy: 'bankAccount', cascade: ['persist', 'remove'])]
    private ?Person $person = null;

    public function getId(): ?int
    {
        return $this->id;
    }

    public function getIban(): ?string
    {
        return $this->iban;
    }

    public function setIban(string $iban): static
    {
        $this->iban = $iban;

        return $this;
    }

    public function getBankName(): ?string
    {
        return $this->bank_name;
    }

    public function setBankName(string $bank_name): static
    {
        $this->bank_name = $bank_name;

        return $this;
    }

    public function getPerson(): ?Person
    {
        return $this->person;
    }

    public function setPerson(?Person $person): static
    {
        $this->person = $person;

        return $this;
    }
}


---
File: src/Entity/Person.php
---

<?php

namespace App\Entity;

use App\Repository\PersonRepository;
use Doctrine\Common\Collections\ArrayCollection;
use Doctrine\Common\Collections\Collection;
use Doctrine\ORM\Mapping as ORM;

#[ORM\Entity(repositoryClass: PersonRepository::class)]
#[ORM\Table(name: "ex09_persons")]
class Person
{
    #[ORM\Id]
    #[ORM\GeneratedValue]
    #[ORM\Column]
    private ?int $id = null;

    #[ORM\Column(length: 64)]
    private ?string $username = null;

    #[ORM\Column(length: 64)]
    private ?string $name = null;

    #[ORM\Column(length: 128)]
    private ?string $email = null;

    #[ORM\Column]
    private ?bool $enable = null;

    #[ORM\Column]
    private ?\DateTime $birthdate = null;

    #[ORM\Column(type: "string",columnDefinition: "ENUM('single', 'married', 'widower') DEFAULT 'single'")]
    private string $marital_status = 'single';

    /**
     * @var Collection<int, Address>
     */
    #[ORM\OneToMany(targetEntity: Address::class, mappedBy: 'person')]
    private Collection $addresses;

    #[ORM\OneToOne(mappedBy: 'person', cascade: ['persist', 'remove'])]
    private ?BankAccount $bankAccount = null;

    public function __construct()
    {
        $this->addresses = new ArrayCollection();
    }

    public function getId(): ?int
    {
        return $this->id;
    }

    public function getUsername(): ?string
    {
        return $this->username;
    }

    public function setUsername(string $username): static
    {
        $this->username = $username;

        return $this;
    }

    public function getName(): ?string
    {
        return $this->name;
    }

    public function setName(string $name): static
    {
        $this->name = $name;

        return $this;
    }

    public function getEmail(): ?string
    {
        return $this->email;
    }

    public function setEmail(string $email): static
    {
        $this->email = $email;

        return $this;
    }

    public function isEnable(): ?bool
    {
        return $this->enable;
    }

    public function setEnable(bool $enable): static
    {
        $this->enable = $enable;

        return $this;
    }

    public function getBirthdate(): ?\DateTime
    {
        return $this->birthdate;
    }

    public function setBirthdate(\DateTime $birthdate): static
    {
        $this->birthdate = $birthdate;

        return $this;
    }

    // Getters/setters
    public function getMaritalStatus(): string
    {
        return $this->marital_status;
    }

    public function setMaritalStatus(string $marital_status): static
    {
        $this->marital_status = $marital_status;
        return $this;
    }

    /**
     * @return Collection<int, Address>
     */
    public function getAddresses(): Collection
    {
        return $this->addresses;
    }

    public function addAddress(Address $address): static
    {
        if (!$this->addresses->contains($address)) {
            $this->addresses->add($address);
            $address->setPerson($this);
        }

        return $this;
    }

    public function removeAddress(Address $address): static
    {
        if ($this->addresses->removeElement($address)) {
            // set the owning side to null (unless already changed)
            if ($address->getPerson() === $this) {
                $address->setPerson(null);
            }
        }

        return $this;
    }

    public function getBankAccount(): ?BankAccount
    {
        return $this->bankAccount;
    }

    public function setBankAccount(?BankAccount $bankAccount): static
    {
        // unset the owning side of the relation if necessary
        if ($bankAccount === null && $this->bankAccount !== null) {
            $this->bankAccount->setPerson(null);
        }

        // set the owning side of the relation if necessary
        if ($bankAccount !== null && $bankAccount->getPerson() !== $this) {
            $bankAccount->setPerson($this);
        }

        $this->bankAccount = $bankAccount;

        return $this;
    }
}


---
File: src/Kernel.php
---

<?php

namespace App;

use Symfony\Bundle\FrameworkBundle\Kernel\MicroKernelTrait;
use Symfony\Component\HttpKernel\Kernel as BaseKernel;

class Kernel extends BaseKernel
{
    use MicroKernelTrait;
}


---
File: src/Repository/AddressRepository.php
---

<?php

namespace App\Repository;

use App\Entity\Address;
use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;
use Doctrine\Persistence\ManagerRegistry;

/**
 * @extends ServiceEntityRepository<Address>
 */
class AddressRepository extends ServiceEntityRepository
{
    public function __construct(ManagerRegistry $registry)
    {
        parent::__construct($registry, Address::class);
    }

    //    /**
    //     * @return Address[] Returns an array of Address objects
    //     */
    //    public function findByExampleField($value): array
    //    {
    //        return $this->createQueryBuilder('a')
    //            ->andWhere('a.exampleField = :val')
    //            ->setParameter('val', $value)
    //            ->orderBy('a.id', 'ASC')
    //            ->setMaxResults(10)
    //            ->getQuery()
    //            ->getResult()
    //        ;
    //    }

    //    public function findOneBySomeField($value): ?Address
    //    {
    //        return $this->createQueryBuilder('a')
    //            ->andWhere('a.exampleField = :val')
    //            ->setParameter('val', $value)
    //            ->getQuery()
    //            ->getOneOrNullResult()
    //        ;
    //    }
}


---
File: src/Repository/BankAccountRepository.php
---

<?php

namespace App\Repository;

use App\Entity\BankAccount;
use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;
use Doctrine\Persistence\ManagerRegistry;

/**
 * @extends ServiceEntityRepository<BankAccount>
 */
class BankAccountRepository extends ServiceEntityRepository
{
    public function __construct(ManagerRegistry $registry)
    {
        parent::__construct($registry, BankAccount::class);
    }

    //    /**
    //     * @return BankAccount[] Returns an array of BankAccount objects
    //     */
    //    public function findByExampleField($value): array
    //    {
    //        return $this->createQueryBuilder('b')
    //            ->andWhere('b.exampleField = :val')
    //            ->setParameter('val', $value)
    //            ->orderBy('b.id', 'ASC')
    //            ->setMaxResults(10)
    //            ->getQuery()
    //            ->getResult()
    //        ;
    //    }

    //    public function findOneBySomeField($value): ?BankAccount
    //    {
    //        return $this->createQueryBuilder('b')
    //            ->andWhere('b.exampleField = :val')
    //            ->setParameter('val', $value)
    //            ->getQuery()
    //            ->getOneOrNullResult()
    //        ;
    //    }
}


---
File: src/Repository/PersonRepository.php
---

<?php

namespace App\Repository;

use App\Entity\Person;
use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;
use Doctrine\Persistence\ManagerRegistry;

/**
 * @extends ServiceEntityRepository<Person>
 */
class PersonRepository extends ServiceEntityRepository
{
    public function __construct(ManagerRegistry $registry)
    {
        parent::__construct($registry, Person::class);
    }

    //    /**
    //     * @return Person[] Returns an array of Person objects
    //     */
    //    public function findByExampleField($value): array
    //    {
    //        return $this->createQueryBuilder('p')
    //            ->andWhere('p.exampleField = :val')
    //            ->setParameter('val', $value)
    //            ->orderBy('p.id', 'ASC')
    //            ->setMaxResults(10)
    //            ->getQuery()
    //            ->getResult()
    //        ;
    //    }

    //    public function findOneBySomeField($value): ?Person
    //    {
    //        return $this->createQueryBuilder('p')
    //            ->andWhere('p.exampleField = :val')
    //            ->setParameter('val', $value)
    //            ->getQuery()
    //            ->getOneOrNullResult()
    //        ;
    //    }
}


---
File: src/Service/CreateTableService.php
---

<?php 

namespace App\Service;

use Exception;
use Doctrine\DBAL\Connection;
use App\Service\UtilsTableService;
use Symfony\Component\Process\Process;

class CreateTableService 
{
    public function __construct(
        private readonly Connection $orm_connection,
        private readonly UtilsTableService $utilsTableService
    ) {}

    // Version 1 : SANS marital_status
    public function migrateToVersionWithoutMaritalStatus(): string
    {
        // Si dÃ©jÃ  Ã  V2, faire rollback de V2
        if ($this->maritalStatusExists())
            return $this->rollbackFromVersion('DoctrineMigrations\\Version20251109121119');
        
        if ($this->utilsTableService->checkTableExistence('ex09_persons'))
            return 'info: Already at Version 1 (WITHOUT marital_status).';
        
        return $this->executeCommand('DoctrineMigrations\\Version20251109120844');
    }

    // Version 2 : AVEC marital_status
    public function migrateToVersionWithMaritalStatus(): string
    {
        if ($this->maritalStatusExists())
            return 'info: Already at Version 2 (WITH marital_status).';
        
        return $this->executeCommand('DoctrineMigrations\\Version20251109121119');
    }

    private function executeCommand(string $version): string
    {
        try
        {
            $process = new Process([
                'php',
                'bin/console',
                'doctrine:migrations:migrate',
                $version,
                '--no-interaction'
            ]);
            
            $process->setWorkingDirectory(__DIR__ . '/../../');
            $process->run();
            
            if ($process->isSuccessful())
                return 'success: Migration successful!';
            else
                return 'error: ' . $process->getErrorOutput();
        }
        catch (Exception $e)
        {
            return 'error: ' . $e->getMessage();
        }
    }

    // â† NEW FUNCTION
    private function rollbackFromVersion(string $version): string
    {
        try
        {
            // Execute le down() de cette version
            $process = new Process([
                'php',
                'bin/console',
                'doctrine:migrations:execute',
                $version,
                '--down',  // â† Important !
                '--no-interaction'
            ]);
            
            $process->setWorkingDirectory(__DIR__ . '/../../');
            $process->run();
            
            if ($process->isSuccessful())
                return 'success: Rolled back to Version 1!';
            else
                return 'error: ' . $process->getErrorOutput();
        }
        catch (Exception $e)
        {
            return 'error: ' . $e->getMessage();
        }
    }

    private function maritalStatusExists(): bool
    {
        try
        {
            $schemaManager = $this->orm_connection->createSchemaManager();
            
            if (!$schemaManager->tablesExist(['ex09_persons']))
                return false;
            
            $table = $schemaManager->introspectTable('ex09_persons');
            return $table->hasColumn('marital_status');
        }
        catch (Exception $e)
        {
            return false;
        }
    }
}
?>

---
File: src/Service/DeleteTableService.php
---

<?php 

namespace App\Service;

use Exception;
use Doctrine\DBAL\Connection;
use App\Service\UtilsTableService;
use Symfony\Component\Process\Process;

class DeleteTableService 
{
	public function __construct(
		private readonly Connection $orm_connection,
		private readonly UtilsTableService $utilsTableService
	) {}
	public function dropAllTables(string $tableName): string
    {
        try
        {
			if (!$this->utilsTableService->checkTableExistence($tableName))
				return 'info: Tables do not exist.';
            $process = new Process([
                'php',
                'bin/console',
                'doctrine:migrations:migrate',
                '0',
                '--no-interaction'
            ]);
            
            $process->setWorkingDirectory(__DIR__ . '/../../');
            $process->run();
            
            if ($process->isSuccessful())
                return 'success: All tables dropped successfully!';
            else
                return 'danger: ' . $process->getErrorOutput();
        }
        catch (Exception $e)
        {
            return 'danger: ' . $e->getMessage();
        }
    }
}

---
File: src/Service/UtilsTableService.php
---

<?php 

namespace App\Service;

use Exception;
use Doctrine\DBAL\Connection;
use Symfony\Component\Process\Process;

class UtilsTableService 
{
	public function __construct(
		private readonly Connection $orm_connection
	) {}

	public function getMigrationStatus(): array
    {
        try
        {
            $process = new Process([
                'php',
                'bin/console',
                'doctrine:migrations:status',
                '--format=json'
            ]);
            
            $process->setWorkingDirectory(__DIR__ . '/../../');
            $process->run();
            
            if ($process->isSuccessful())
                return json_decode($process->getOutput(), true);
            else
                return ['error' => $process->getErrorOutput()];
        }
        catch (Exception $e)
        {
            return ['error' => $e->getMessage()];
        }
    }

	public function checkTableExistence(string $tableName): bool
	{
		try
		{
			$schemaManager = $this->orm_connection->createSchemaManager();
			return $schemaManager->tablesExist([$tableName]);
		}
		catch (Exception $e)
		{
			return false;
		}
	}
}

================================================================================

ðŸ“‚ PUBLIC FILES (public/) - Location: ex09/public/
================================================================================


---
File: public/index.php
---

<?php

use App\Kernel;

require_once dirname(__DIR__).'/vendor/autoload_runtime.php';

return function (array $context) {
    return new Kernel($context['APP_ENV'], (bool) $context['APP_DEBUG']);
};


---
File: public/style.css
---

.alert
{
    padding: 1em 1.5em;
    margin: 1em 0;
    border-radius: 5px;
    font-weight: bold;
    box-shadow: 0 1px 7px #aaa1;
    font-size: 1em;
}

.alert-success
{
    background: #d4edda;
    color: #155724;
    border-left: 7px solid #38a169;
}

.alert-danger
{
    background: #f8d7da;
    color: #721c24;
    border-left: 7px solid #e53e3e;
}

.alert-info
{
    background: #ffee00;
    color: #000000;
    border-left: 7px solid #d8db38;
}
