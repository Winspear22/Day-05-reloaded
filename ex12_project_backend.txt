================================================================================
PROJECT STRUCTURE OVERVIEW - ex12
================================================================================

Root Directory: ./ex12/

./ex12
â”œâ”€â”€ bin
â”‚Â Â  â””â”€â”€ console
â”œâ”€â”€ composer.json
â”œâ”€â”€ composer.lock
â”œâ”€â”€ config
â”‚Â Â  â”œâ”€â”€ bundles.php
â”‚Â Â  â”œâ”€â”€ packages
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ cache.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ doctrine_migrations.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ doctrine.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ framework.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ routing.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ twig.yaml
â”‚Â Â  â”‚Â Â  â””â”€â”€ validator.yaml
â”‚Â Â  â”œâ”€â”€ preload.php
â”‚Â Â  â”œâ”€â”€ routes
â”‚Â Â  â”‚Â Â  â””â”€â”€ framework.yaml
â”‚Â Â  â”œâ”€â”€ routes.yaml
â”‚Â Â  â””â”€â”€ services.yaml
â”œâ”€â”€ migrations
â”‚Â Â  â””â”€â”€ Version20251111121039.php
â”œâ”€â”€ public
â”‚Â Â  â”œâ”€â”€ index.php
â”‚Â Â  â””â”€â”€ style.css
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ Controller
â”‚Â Â  â”‚Â Â  â””â”€â”€ Ex12Controller.php
â”‚Â Â  â”œâ”€â”€ DataFixtures
â”‚Â Â  â”‚Â Â  â””â”€â”€ AppFixtures.php
â”‚Â Â  â”œâ”€â”€ DTO
â”‚Â Â  â”‚Â Â  â””â”€â”€ SearchRequest.php
â”‚Â Â  â”œâ”€â”€ Entity
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Address.php
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BankAccount.php
â”‚Â Â  â”‚Â Â  â””â”€â”€ Person.php
â”‚Â Â  â”œâ”€â”€ Kernel.php
â”‚Â Â  â”œâ”€â”€ Repository
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AddressRepository.php
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BankAccountRepository.php
â”‚Â Â  â”‚Â Â  â””â”€â”€ PersonRepository.php
â”‚Â Â  â””â”€â”€ Service
â”‚Â Â      â”œâ”€â”€ CreateTableService.php
â”‚Â Â      â”œâ”€â”€ DeleteTableService.php
â”‚Â Â      â”œâ”€â”€ UtilsTableService.php
â”‚Â Â      â””â”€â”€ ValidationQueryService.php
â”œâ”€â”€ symfony.lock
â”œâ”€â”€ templates
â”‚Â Â  â”œâ”€â”€ base.html.twig
â”‚Â Â  â”œâ”€â”€ bundles
â”‚Â Â  â”‚Â Â  â””â”€â”€ TwigBundle
â”‚Â Â  â””â”€â”€ ex12
â”‚Â Â      â””â”€â”€ index.html.twig
â”œâ”€â”€ var
â”‚Â Â  â”œâ”€â”€ cache
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ dev
â”‚Â Â  â”‚Â Â  â””â”€â”€ prod
â”‚Â Â  â””â”€â”€ log
â””â”€â”€ vendor
    â”œâ”€â”€ autoload.php
    â”œâ”€â”€ autoload_runtime.php
    â”œâ”€â”€ bin
    â”‚Â Â  â”œâ”€â”€ doctrine-migrations
    â”‚Â Â  â”œâ”€â”€ patch-type-declarations
    â”‚Â Â  â”œâ”€â”€ php-parse
    â”‚Â Â  â”œâ”€â”€ sql-formatter
    â”‚Â Â  â”œâ”€â”€ var-dump-server
    â”‚Â Â  â””â”€â”€ yaml-lint
    â”œâ”€â”€ composer
    â”‚Â Â  â”œâ”€â”€ autoload_classmap.php
    â”‚Â Â  â”œâ”€â”€ autoload_files.php
    â”‚Â Â  â”œâ”€â”€ autoload_namespaces.php
    â”‚Â Â  â”œâ”€â”€ autoload_psr4.php
    â”‚Â Â  â”œâ”€â”€ autoload_real.php
    â”‚Â Â  â”œâ”€â”€ autoload_static.php
    â”‚Â Â  â”œâ”€â”€ ClassLoader.php
    â”‚Â Â  â”œâ”€â”€ installed.json
    â”‚Â Â  â”œâ”€â”€ installed.php
    â”‚Â Â  â”œâ”€â”€ InstalledVersions.php
    â”‚Â Â  â”œâ”€â”€ LICENSE
    â”‚Â Â  â””â”€â”€ platform_check.php
    â”œâ”€â”€ doctrine
    â”‚Â Â  â”œâ”€â”€ annotations
    â”‚Â Â  â”œâ”€â”€ collections
    â”‚Â Â  â”œâ”€â”€ data-fixtures
    â”‚Â Â  â”œâ”€â”€ dbal
    â”‚Â Â  â”œâ”€â”€ deprecations
    â”‚Â Â  â”œâ”€â”€ doctrine-bundle
    â”‚Â Â  â”œâ”€â”€ doctrine-fixtures-bundle
    â”‚Â Â  â”œâ”€â”€ doctrine-migrations-bundle
    â”‚Â Â  â”œâ”€â”€ event-manager
    â”‚Â Â  â”œâ”€â”€ inflector
    â”‚Â Â  â”œâ”€â”€ instantiator
    â”‚Â Â  â”œâ”€â”€ lexer
    â”‚Â Â  â”œâ”€â”€ migrations
    â”‚Â Â  â”œâ”€â”€ orm
    â”‚Â Â  â”œâ”€â”€ persistence
    â”‚Â Â  â””â”€â”€ sql-formatter
    â”œâ”€â”€ fakerphp
    â”‚Â Â  â””â”€â”€ faker
    â”œâ”€â”€ nikic
    â”‚Â Â  â””â”€â”€ php-parser
    â”œâ”€â”€ psr
    â”‚Â Â  â”œâ”€â”€ cache
    â”‚Â Â  â”œâ”€â”€ container
    â”‚Â Â  â”œâ”€â”€ event-dispatcher
    â”‚Â Â  â””â”€â”€ log
    â”œâ”€â”€ symfony
    â”‚Â Â  â”œâ”€â”€ asset
    â”‚Â Â  â”œâ”€â”€ cache
    â”‚Â Â  â”œâ”€â”€ cache-contracts
    â”‚Â Â  â”œâ”€â”€ config
    â”‚Â Â  â”œâ”€â”€ console
    â”‚Â Â  â”œâ”€â”€ dependency-injection
    â”‚Â Â  â”œâ”€â”€ deprecation-contracts
    â”‚Â Â  â”œâ”€â”€ doctrine-bridge
    â”‚Â Â  â”œâ”€â”€ dotenv
    â”‚Â Â  â”œâ”€â”€ error-handler
    â”‚Â Â  â”œâ”€â”€ event-dispatcher
    â”‚Â Â  â”œâ”€â”€ event-dispatcher-contracts
    â”‚Â Â  â”œâ”€â”€ filesystem
    â”‚Â Â  â”œâ”€â”€ finder
    â”‚Â Â  â”œâ”€â”€ flex
    â”‚Â Â  â”œâ”€â”€ form
    â”‚Â Â  â”œâ”€â”€ framework-bundle
    â”‚Â Â  â”œâ”€â”€ http-foundation
    â”‚Â Â  â”œâ”€â”€ http-kernel
    â”‚Â Â  â”œâ”€â”€ maker-bundle
    â”‚Â Â  â”œâ”€â”€ options-resolver
    â”‚Â Â  â”œâ”€â”€ polyfill-intl-grapheme
    â”‚Â Â  â”œâ”€â”€ polyfill-intl-icu
    â”‚Â Â  â”œâ”€â”€ polyfill-intl-normalizer
    â”‚Â Â  â”œâ”€â”€ polyfill-mbstring
    â”‚Â Â  â”œâ”€â”€ polyfill-php83
    â”‚Â Â  â”œâ”€â”€ polyfill-php84
    â”‚Â Â  â”œâ”€â”€ process
    â”‚Â Â  â”œâ”€â”€ property-access
    â”‚Â Â  â”œâ”€â”€ property-info
    â”‚Â Â  â”œâ”€â”€ routing
    â”‚Â Â  â”œâ”€â”€ runtime
    â”‚Â Â  â”œâ”€â”€ service-contracts
    â”‚Â Â  â”œâ”€â”€ stopwatch
    â”‚Â Â  â”œâ”€â”€ string
    â”‚Â Â  â”œâ”€â”€ translation-contracts
    â”‚Â Â  â”œâ”€â”€ twig-bridge
    â”‚Â Â  â”œâ”€â”€ twig-bundle
    â”‚Â Â  â”œâ”€â”€ validator
    â”‚Â Â  â”œâ”€â”€ var-dumper
    â”‚Â Â  â”œâ”€â”€ var-exporter
    â”‚Â Â  â””â”€â”€ yaml
    â””â”€â”€ twig
        â”œâ”€â”€ extra-bundle
        â””â”€â”€ twig

97 directories, 55 files

================================================================================

ðŸ“‚ SOURCE CODE (src/) - Location: ex12/src/
================================================================================


---
File: src/Controller/Ex12Controller.php
---

<?php

namespace App\Controller;

use Exception;
use App\Service\CreateTableService;
use App\Service\DeleteTableService;
use App\Service\LoadDemoDataService;
use App\Service\ValidationQueryService;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Attribute\Route;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;

final class Ex12Controller extends AbstractController
{
        public function __construct(
        private readonly LoadDemoDataService $loadDemoData,
        private readonly CreateTableService $createTable,
        private readonly DeleteTableService $deleteTable,
        private readonly ValidationQueryService $validationQueryService
    ) {}

    /**
     * @Route("/ex12", name="ex12_index", methods={"GET"})
     */
    public function index(): Response
    {  
        return $this->render('ex12/index.html.twig');
    }

    /**
     * @Route("/ex12/create_all_tables", name="ex12_create_all_tables", methods={"POST"})
     */
    public function createAllTables(): Response
    {
        try
        {
            $result = $this->createTable->createTable("ex12_persons");
            [$type, $msg] = explode(':', $result, 2);
            $this->addFlash($type, $msg);
        }
        catch (Exception $e)
        {
            $this->addFlash('danger', 'Error: ' . $e->getMessage());
        }
        return $this->redirectToRoute('ex12_index');
    }

    /**
     * @Route("/ex12/delete_all_tables_content", name="ex12_delete_all_tables_content", methods={"POST"})
     */
    public function deleteAllTablesContent(): Response
    {
        try
        {
            $result = $this->deleteTable->deleteAllTableContent();
            [$type, $msg] = explode(':', $result, 2);
            $this->addFlash($type, $msg);
        }
        catch (Exception $e)
        {
            $this->addFlash('danger', 'Error: ' . $e->getMessage());
        }
        return $this->redirectToRoute('ex12_index');
    }

    /**
     * @Route("/ex12/load_demo_data", name="ex12_load_demo_data", methods={"POST"})
     */
    public function loadDemoData(): Response
    {
        try
        {
            $result = $this->loadDemoData->loadData();
            [$type, $msg] = explode(':', $result, 2);
            $this->addFlash($type, $msg);
            return $this->redirectToRoute('ex12_index');
        }
        catch (Exception $e)
        {
            $this->addFlash('danger', 'Error: ' . $e->getMessage());
        }
        return $this->redirectToRoute('ex12_index');
    }
}


---
File: src/DataFixtures/AppFixtures.php
---

<?php

namespace App\DataFixtures;

use App\Entity\Person;
use App\Entity\Address;
use App\Entity\BankAccount;
use Faker\Factory;
use Doctrine\Persistence\ObjectManager;
use Doctrine\Bundle\FixturesBundle\Fixture;

class AppFixtures extends Fixture
{
    public function load(ObjectManager $manager): void
    {
        $faker = Factory::create('fr_FR');
        $persons = [];

        // CrÃ©e 20 personnes
        for ($i = 0; $i < 20; $i++)
        {
            $person = new Person();
            $person->setUsername($faker->unique()->userName());
            $person->setName($faker->name());
            $person->setEmail($faker->unique()->email());
            $person->setEnable($faker->boolean());
            $person->setBirthdate($faker->dateTime());

            $manager->persist($person);
            $persons[] = $person;  // â† Stocke la personne
        }

        // Flush pour que les IDs soient gÃ©nÃ©rÃ©s
        $manager->flush();

        // CrÃ©e 20 adresses ET comptes bancaires avec les vraies personnes
        foreach ($persons as $person)
        {
            // Adresse
            $address = new Address();
            $address->setAddress($faker->address());
            $address->setPerson($person);
            $manager->persist($address);

            // Compte bancaire
            $bankAccount = new BankAccount();
            $bankAccount->setIban($faker->iban('FR'));
            $bankAccount->setBankName($faker->company());
            $bankAccount->setPerson($person);
            $manager->persist($bankAccount);
        }

        // Flush final
        $manager->flush();
    }
}


---
File: src/DTO/SearchRequest.php
---

<?php

namespace App\DTO;

class SearchRequest
{
    public function __construct(
        public readonly string $filterName = '',
        public readonly string $sortBy = 'name',
        public readonly string $sortDirection = 'asc',
        public readonly int $limit = 100,
        public readonly array $messages = []
    ) {}
}
?>

---
File: src/Entity/Address.php
---

<?php

namespace App\Entity;

use App\Repository\AddressRepository;
use Doctrine\DBAL\Types\Types;
use Doctrine\ORM\Mapping as ORM;

#[ORM\Entity(repositoryClass: AddressRepository::class)]
#[ORM\Table(name: "ex12_addresses")]
class Address
{
    #[ORM\Id]
    #[ORM\GeneratedValue]
    #[ORM\Column]
    private ?int $id = null;

    #[ORM\Column(type: Types::TEXT)]
    private ?string $address = null;

    #[ORM\ManyToOne(inversedBy: 'addresses')]
    private ?Person $person = null;

    public function getId(): ?int
    {
        return $this->id;
    }

    public function getAddress(): ?string
    {
        return $this->address;
    }

    public function setAddress(string $address): static
    {
        $this->address = $address;

        return $this;
    }

    public function getPerson(): ?Person
    {
        return $this->person;
    }

    public function setPerson(?Person $person): static
    {
        $this->person = $person;

        return $this;
    }
}


---
File: src/Entity/BankAccount.php
---

<?php

namespace App\Entity;

use App\Repository\BankAccountRepository;
use Doctrine\ORM\Mapping as ORM;

#[ORM\Entity(repositoryClass: BankAccountRepository::class)]
#[ORM\Table(name: "ex12_bank_accounts")]
class BankAccount
{
    #[ORM\Id]
    #[ORM\GeneratedValue]
    #[ORM\Column]
    private ?int $id = null;

    #[ORM\Column(length: 34)]
    private ?string $iban = null;

    #[ORM\Column(length: 50)]
    private ?string $bank_name = null;

    #[ORM\OneToOne(inversedBy: 'bankAccount', cascade: ['persist', 'remove'])]
    private ?Person $person = null;

    public function getId(): ?int
    {
        return $this->id;
    }

    public function getIban(): ?string
    {
        return $this->iban;
    }

    public function setIban(string $iban): static
    {
        $this->iban = $iban;

        return $this;
    }

    public function getBankName(): ?string
    {
        return $this->bank_name;
    }

    public function setBankName(string $bank_name): static
    {
        $this->bank_name = $bank_name;

        return $this;
    }

    public function getPerson(): ?Person
    {
        return $this->person;
    }

    public function setPerson(?Person $person): static
    {
        $this->person = $person;

        return $this;
    }
}


---
File: src/Entity/Person.php
---

<?php

namespace App\Entity;

use App\Repository\PersonRepository;
use Doctrine\Common\Collections\ArrayCollection;
use Doctrine\Common\Collections\Collection;
use Doctrine\ORM\Mapping as ORM;

#[ORM\Entity(repositoryClass: PersonRepository::class)]
#[ORM\Table(name: "ex12_persons")]
class Person
{
    #[ORM\Id]
    #[ORM\GeneratedValue]
    #[ORM\Column]
    private ?int $id = null;

    #[ORM\Column(length: 64)]
    private ?string $username = null;

    #[ORM\Column(length: 64)]
    private ?string $name = null;

    #[ORM\Column(length: 128)]
    private ?string $email = null;

    #[ORM\Column]
    private ?bool $enable = null;

    #[ORM\Column]
    private ?\DateTime $birthdate = null;

    /**
     * @var Collection<int, Address>
     */
    #[ORM\OneToMany(targetEntity: Address::class, mappedBy: 'person')]
    private Collection $addresses;

    #[ORM\OneToOne(mappedBy: 'person', cascade: ['persist', 'remove'])]
    private ?BankAccount $bankAccount = null;

    public function __construct()
    {
        $this->addresses = new ArrayCollection();
    }

    public function getId(): ?int
    {
        return $this->id;
    }

    public function getUsername(): ?string
    {
        return $this->username;
    }

    public function setUsername(string $username): static
    {
        $this->username = $username;

        return $this;
    }

    public function getName(): ?string
    {
        return $this->name;
    }

    public function setName(string $name): static
    {
        $this->name = $name;

        return $this;
    }

    public function getEmail(): ?string
    {
        return $this->email;
    }

    public function setEmail(string $email): static
    {
        $this->email = $email;

        return $this;
    }

    public function isEnable(): ?bool
    {
        return $this->enable;
    }

    public function setEnable(bool $enable): static
    {
        $this->enable = $enable;

        return $this;
    }

    public function getBirthdate(): ?\DateTime
    {
        return $this->birthdate;
    }

    public function setBirthdate(\DateTime $birthdate): static
    {
        $this->birthdate = $birthdate;

        return $this;
    }

    /**
     * @return Collection<int, Address>
     */
    public function getAddresses(): Collection
    {
        return $this->addresses;
    }

    public function addAddress(Address $address): static
    {
        if (!$this->addresses->contains($address)) {
            $this->addresses->add($address);
            $address->setPerson($this);
        }

        return $this;
    }

    public function removeAddress(Address $address): static
    {
        if ($this->addresses->removeElement($address)) {
            // set the owning side to null (unless already changed)
            if ($address->getPerson() === $this) {
                $address->setPerson(null);
            }
        }

        return $this;
    }

    public function getBankAccount(): ?BankAccount
    {
        return $this->bankAccount;
    }

    public function setBankAccount(?BankAccount $bankAccount): static
    {
        // unset the owning side of the relation if necessary
        if ($bankAccount === null && $this->bankAccount !== null) {
            $this->bankAccount->setPerson(null);
        }

        // set the owning side of the relation if necessary
        if ($bankAccount !== null && $bankAccount->getPerson() !== $this) {
            $bankAccount->setPerson($this);
        }

        $this->bankAccount = $bankAccount;

        return $this;
    }
}


---
File: src/Kernel.php
---

<?php

namespace App;

use Symfony\Bundle\FrameworkBundle\Kernel\MicroKernelTrait;
use Symfony\Component\HttpKernel\Kernel as BaseKernel;

class Kernel extends BaseKernel
{
    use MicroKernelTrait;
}


---
File: src/Repository/AddressRepository.php
---

<?php

namespace App\Repository;

use App\Entity\Address;
use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;
use Doctrine\Persistence\ManagerRegistry;

/**
 * @extends ServiceEntityRepository<Address>
 */
class AddressRepository extends ServiceEntityRepository
{
    public function __construct(ManagerRegistry $registry)
    {
        parent::__construct($registry, Address::class);
    }

    //    /**
    //     * @return Address[] Returns an array of Address objects
    //     */
    //    public function findByExampleField($value): array
    //    {
    //        return $this->createQueryBuilder('a')
    //            ->andWhere('a.exampleField = :val')
    //            ->setParameter('val', $value)
    //            ->orderBy('a.id', 'ASC')
    //            ->setMaxResults(10)
    //            ->getQuery()
    //            ->getResult()
    //        ;
    //    }

    //    public function findOneBySomeField($value): ?Address
    //    {
    //        return $this->createQueryBuilder('a')
    //            ->andWhere('a.exampleField = :val')
    //            ->setParameter('val', $value)
    //            ->getQuery()
    //            ->getOneOrNullResult()
    //        ;
    //    }
}


---
File: src/Repository/BankAccountRepository.php
---

<?php

namespace App\Repository;

use App\Entity\BankAccount;
use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;
use Doctrine\Persistence\ManagerRegistry;

/**
 * @extends ServiceEntityRepository<BankAccount>
 */
class BankAccountRepository extends ServiceEntityRepository
{
    public function __construct(ManagerRegistry $registry)
    {
        parent::__construct($registry, BankAccount::class);
    }

    //    /**
    //     * @return BankAccount[] Returns an array of BankAccount objects
    //     */
    //    public function findByExampleField($value): array
    //    {
    //        return $this->createQueryBuilder('b')
    //            ->andWhere('b.exampleField = :val')
    //            ->setParameter('val', $value)
    //            ->orderBy('b.id', 'ASC')
    //            ->setMaxResults(10)
    //            ->getQuery()
    //            ->getResult()
    //        ;
    //    }

    //    public function findOneBySomeField($value): ?BankAccount
    //    {
    //        return $this->createQueryBuilder('b')
    //            ->andWhere('b.exampleField = :val')
    //            ->setParameter('val', $value)
    //            ->getQuery()
    //            ->getOneOrNullResult()
    //        ;
    //    }
}


---
File: src/Repository/PersonRepository.php
---

<?php

namespace App\Repository;

use App\Entity\Person;
use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;
use Doctrine\Persistence\ManagerRegistry;

/**
 * @extends ServiceEntityRepository<Person>
 */
class PersonRepository extends ServiceEntityRepository
{
    public function __construct(ManagerRegistry $registry)
    {
        parent::__construct($registry, Person::class);
    }

    public function getPersonsGrouped(
            string $filterName = '',
            string $sortBy = 'name',
            string $sortDir = 'asc'
        ): array
        {
            $allowedSorts = ['name', 'email', 'birthdate'];
            $allowedDir = ['asc', 'desc'];

            if (!in_array($sortBy, $allowedSorts, true))
                $sortBy = 'name';

            if (!in_array($sortDir, $allowedDir, true))
                $sortDir = 'asc';

            $qb = $this->createQueryBuilder('p')
                ->leftJoin('p.addresses', 'a')->addSelect('a')
                ->leftJoin('p.bankAccount', 'b')->addSelect('b');

            if (!empty(trim($filterName)))
            {
                $qb->andWhere('p.name LIKE :filter')
                ->setParameter('filter', "%{$filterName}%");
            }

            $qb->orderBy("p.{$sortBy}", strtoupper($sortDir))
            ->addOrderBy('p.id', 'ASC');

            return $qb->getQuery()->getResult();
    }
}


---
File: src/Service/CreateTableService.php
---

<?php 

namespace App\Service;

use Exception;
use Doctrine\DBAL\Connection;
use App\Service\UtilsTableService;
use Symfony\Component\Process\Process;

class CreateTableService 
{
    public function __construct(
        private readonly Connection $orm_connection,
        private readonly UtilsTableService $utilsTableService
    ) {}

	public function createTable(string $tableName): string
	{
		try
		{
			if ($this->utilsTableService->checkTableExistence($tableName))
				return 'info:Table already exists.';

			$process = new Process([
				'php',
				'bin/console',
				'doctrine:migrations:migrate',
				'--no-interaction'
			]);
			$process->setWorkingDirectory(__DIR__ . '/../../');
			$process->run();
			if ($process->isSuccessful())
				return 'success:Table created successfully!';
			else
				return 'error: ' . $process->getErrorOutput();
		} 
		catch (Exception $e)
		{
			return 'error: ' . $e->getMessage();
		}
	}
}
?>

---
File: src/Service/DeleteTableService.php
---

<?php 

namespace App\Service;

use Exception;
use App\Repository\PersonRepository;
use App\Service\UtilsTableService;
use Doctrine\ORM\EntityManagerInterface;

class DeleteTableService 
{
	public function __construct(
        private readonly EntityManagerInterface $em,
		private readonly PersonRepository $repo,
        private readonly UtilsTableService $utilsTableService
	) {}
    
    public function deleteAllTableContent(): string
    {
        try
        {
            if (!$this->utilsTableService->checkTableExistence('ex12_persons'))
                return 'danger:Table ex12_persons does not exist.';

            if (!$this->utilsTableService->checkTableExistence('ex12_addresses'))
                return 'danger:Table ex12_addresses does not exist.';

            if (!$this->utilsTableService->checkTableExistence('ex12_bank_accounts'))
                return 'danger:Table ex12_bank_accounts does not exist.';

            $persons = $this->repo->findAll();

            if (empty($persons))
                return 'info:No data to delete.';

            foreach ($persons as $person)
                $this->em->remove($person);
            $this->em->flush();
            return 'success:All data deleted successfully!';
        }
        catch (Exception $e)
        {
            return 'danger:' . $e->getMessage();
        }
    }
}

---
File: src/Service/UtilsTableService.php
---

<?php 

namespace App\Service;

use Exception;
use Doctrine\DBAL\Connection;
use Symfony\Component\Process\Process;

class UtilsTableService 
{
	public function __construct(
		private readonly Connection $orm_connection
	) {}

	public function checkTableExistence(string $tableName): bool
	{
		try
		{
			$schemaManager = $this->orm_connection->createSchemaManager();
			return $schemaManager->tablesExist([$tableName]);
		}
		catch (Exception $e)
		{
			return false;
		}
	}
}

---
File: src/Service/ValidationQueryService.php
---

<?php

namespace App\Service;

use App\DTO\SearchRequest;
use Symfony\Component\HttpFoundation\Request;


class ValidationQueryService
{
    public function validateQueryParams(Request $request): SearchRequest
    {
        $messages = [];

        $filterName = trim($request->query->get('filter_name', ''));
        if (mb_strlen($filterName) > 64)
		{
            $original = $filterName;
            $filterName = mb_substr($filterName, 0, 64);
            $messages[] = ['warning', sprintf('Truncated from %d to 64 chars', mb_strlen($original))];
        }
        if ($filterName && !preg_match('/^[\p{L}\p{N} _\'\-\.,]*$/u', $filterName))
		{
            $messages[] = ['danger', 'Invalid characters in filter.'];
            $filterName = '';
        }

        $allowedSorts = ['name', 'email', 'birthdate'];
        $sortBy = $request->query->get('sort_by', 'name');
        if (!in_array($sortBy, $allowedSorts, true))
		{
            $messages[] = ['danger', 'Invalid sort field. Using default.'];
            $sortBy = 'name';
        }

        $allowedDirs = ['asc', 'desc'];
        $sortDir = $request->query->get('sort_dir', 'asc');
        if (!in_array($sortDir, $allowedDirs, true))
		{
            $messages[] = ['danger', 'Invalid sort direction. Using ascending.'];
            $sortDir = 'asc';
        }

        // Retourner un DTO structurÃ©
        return new SearchRequest(
            filterName: $filterName,
            sortBy: $sortBy,
            sortDirection: $sortDir,
            limit: 100,
            messages: $messages
        );
    }
}

?>

================================================================================

ðŸ“‚ PUBLIC FILES (public/) - Location: ex12/public/
================================================================================


---
File: public/index.php
---

<?php

use App\Kernel;

require_once dirname(__DIR__).'/vendor/autoload_runtime.php';

return function (array $context) {
    return new Kernel($context['APP_ENV'], (bool) $context['APP_DEBUG']);
};


---
File: public/style.css
---

.alert
{
    padding: 1em 1.5em;
    margin: 1em 0;
    border-radius: 5px;
    font-weight: bold;
    box-shadow: 0 1px 7px #aaa1;
    font-size: 1em;
}

.alert-success
{
    background: #d4edda;
    color: #155724;
    border-left: 7px solid #38a169;
}

.alert-danger
{
    background: #f8d7da;
    color: #721c24;
    border-left: 7px solid #e53e3e;
}

.alert-info
{
    background: #ffee00;
    color: #000000;
    border-left: 7px solid #d8db38;
}
